<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GEOAI | West Java Region Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #050814;
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 20px 24px 28px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.7);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 13px;
      text-transform: uppercase;
      color: #60a5fa;
    }

    .logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34,197,94,0.7);
    }

    .region-sub {
      font-weight: 300;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .region-pill {
      display: inline-flex;
      align-items: center;
      margin-left: 6px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid #1f2937;
    }

    .region-pill select {
      background: transparent;
      border: none;
      color: #e5e7eb;
      font-size: 11px;
      padding: 0 2px;
      outline: none;
      appearance: none;
    }

    .region-title {
      font-size: 24px;
      font-weight: 800;
      letter-spacing: 0.12em;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      text-align: center;
    }

    .region-active {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.08em;
      color: #9ca3af;
      text-transform: uppercase;
    }

    .clock {
      font-family: "JetBrains Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 18px;
      letter-spacing: 0.2em;
      padding: 6px 12px;
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      color: #e5e7eb;
    }

    .grid {
      display: grid;
      grid-template-columns: 2.3fr 1.2fr 1.2fr 1.2fr;
      gap: 14px;
      margin-bottom: 18px;
    }

    .card {
      background: linear-gradient(135deg, #020617, #020617);
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 14px 16px;
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .risk-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(248, 250, 252, 0.06);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-bottom: 10px;
      border: 1px solid rgba(148,163,184,0.4);
    }

    .risk-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.8);
    }

    .risk-chip[data-level="WASPADA"] .risk-dot {
      background: #facc15;
      box-shadow: 0 0 10px rgba(250,204,21,0.8);
    }

    .risk-chip[data-level="SIAGA"] .risk-dot {
      background: #fb923c;
      box-shadow: 0 0 10px rgba(251,146,60,0.8);
    }

    .risk-chip[data-level="DARURAT"] .risk-dot {
      background: #ef4444;
      box-shadow: 0 0 10px rgba(239,68,68,0.8);
    }

    .risk-main-label {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.1em;
      margin-bottom: 4px;
    }

    .risk-sub-label {
      font-size: 11px;
      color: #9ca3af;
    }

    .confidence-bar {
      margin-top: 16px;
      font-size: 11px;
      color: #9ca3af;
    }

    .confidence-track {
      margin-top: 6px;
      width: 100%;
      height: 6px;
      background: #020617;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #111827;
    }

    .confidence-fill {
      height: 100%;
      width: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #facc15, #ef4444);
      transition: width 0.4s ease-out;
    }

    .metric-value {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-unit {
      font-size: 12px;
      color: #9ca3af;
    }

    .metric-extra {
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
      gap: 12px;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 10px;
      white-space: nowrap;
    }

    .footer a {
      color: #9ca3af;
      text-decoration: none;
      border-bottom: 1px dotted #4b5563;
    }

    .footer a:hover {
      color: #e5e7eb;
      border-bottom-style: solid;
    }

    @media (max-width: 900px) {
      body {
        padding: 16px;
      }
      .app {
        padding: 16px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .region-title {
        align-items: flex-start;
      }
      .grid {
        grid-template-columns: 1fr;
      }
      .footer {
        flex-direction: column;
        align-items: flex-start;
      }
      .badge {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="logo">
          <div class="logo-dot"></div>
          GEOAI
        </div>
        <div class="region-sub">
          INDONESIA · WEST JAVA REGION
          <span class="region-pill">
            <select id="regionSelect">
              <option value="bandung">Bandung Raya</option>
              <option value="bogor">Bogor &amp; Puncak</option>
              <option value="sukabumi">Sukabumi Area</option>
            </select>
          </span>
        </div>
      </div>
      <div class="region-title">
        REGION MONITOR
        <div class="region-active" id="regionLabel">Bandung Raya</div>
      </div>
      <div class="clock" id="clock">--:--:--</div>
    </header>

    <div class="grid">
      <!-- Risk card -->
      <div class="card">
        <div class="card-title">Live Analysis · Environmental Risk Level</div>
        <div class="risk-chip" id="riskChip" data-level="AMAN">
          <div class="risk-dot"></div>
          <span id="riskLevelLabel">AMAN</span>
        </div>
        <div class="risk-main-label" id="riskMainText">
          AMAN: KONDISI RELATIF NORMAL
        </div>
        <div class="risk-sub-label">
          Model rule-based sementara · akan diganti model AI/ML ketika dataset historis siap.
        </div>
        <div class="confidence-bar">
          AI Confidence <span id="confValue">0%</span>
          <div class="confidence-track">
            <div class="confidence-fill" id="confBar"></div>
          </div>
        </div>
      </div>

      <!-- Temperature -->
      <div class="card">
        <div class="card-title">Temperature</div>
        <div class="metric-value"><span id="tempVal">--</span>°C</div>
        <div class="metric-unit">Near-surface air temperature</div>
        <div class="metric-extra">Updated · <span id="tempTime">--</span></div>
      </div>

      <!-- Precipitation -->
      <div class="card">
        <div class="card-title">Precipitation</div>
        <div class="metric-value"><span id="precipVal">--</span> mm/h</div>
        <div class="metric-unit">Rainfall intensity per hour</div>
        <div class="metric-extra">Updated · <span id="precipTime">--</span></div>
      </div>

      <!-- Soil saturation -->
      <div class="card">
        <div class="card-title">Soil Saturation</div>
        <div class="metric-value"><span id="soilVal">--</span>%</div>
        <div class="metric-unit">Estimated saturation threshold</div>
        <div class="metric-extra">Updated · <span id="soilTime">--</span></div>
      </div>
    </div>

    <!-- 24h history card -->
    <div class="card" style="margin-top: 8px;">
      <div class="card-title">24h Climate Profile</div>
      <div style="font-size: 11px; color: #9ca3af; margin-bottom: 8px;">
        Temperatur (garis) dan curah hujan (batang) untuk 24 jam terakhir di wilayah terpilih.
      </div>
      <canvas id="historyChart" width="1000" height="150"></canvas>
      <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
        Skala suhu &amp; hujan dinormalisasi agar tren lebih mudah dibaca, bukan angka absolut.
      </div>
    </div>

    <div class="footer">
      <div>
        Data source: Open-Meteo (cuaca) · model risiko rule-based eksperimen banjir &amp; longsor.
        <br />
        Built by
        <a href="https://github.com/7centz-ctrl" target="_blank" rel="noopener">7CENTZ</a>
      </div>
      <div class="badge">AUTO REFRESH · 30s</div>
    </div>
  </div>

  <script>
    function pad(n) {
      return n.toString().padStart(2, "0");
    }

    function updateClock() {
      const el = document.getElementById("clock");
      const now = new Date();
      el.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(
        now.getSeconds()
      )}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    function formatTime(iso) {
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "--:--:--";
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // ====== REGION DEFINITIONS (JAWA BARAT) ======
    const REGIONS = {
      bandung: {
        label: "Bandung Raya",
        lat: -6.9,
        lon: 107.6,
      },
      bogor: {
        label: "Bogor & Puncak",
        lat: -6.6,
        lon: 106.8,
      },
      sukabumi: {
        label: "Sukabumi Area",
        lat: -6.9,
        lon: 106.9,
      },
    };

    function buildUrl(region) {
      const params = new URLSearchParams({
        latitude: region.lat,
        longitude: region.lon,
        current: "temperature_2m,precipitation",
        hourly: "temperature_2m,precipitation,soil_moisture_0_to_1cm",
        past_hours: "24",
        timezone: "auto",
      });
      return "https://api.open-meteo.com/v1/forecast?" + params.toString();
    }

    async function fetchStatus() {
      try {
        const select = document.getElementById("regionSelect");
        const region = REGIONS[select.value];

        // update label aktif
        document.getElementById("regionLabel").textContent = region.label;

        const apiUrl = buildUrl(region);
        const res = await fetch(apiUrl);

        if (!res.ok) {
          console.error("API error", res.status);
          return;
        }

        const raw = await res.json();

        const current = raw.current || {};
        let temp = Number(current.temperature_2m);
        let precip = Number(
          current.precipitation !== undefined ? current.precipitation : 0
        );

        if (Number.isNaN(temp)) temp = 0;
        if (Number.isNaN(precip)) precip = 0;

        // Soil moisture pakai hourly (0–1 cm), fallback ke fungsi precip
        let soilPct = null;
        if (
          raw.hourly &&
          raw.hourly.soil_moisture_0_to_1cm &&
          raw.hourly.soil_moisture_0_to_1cm.length
        ) {
          const smArr = raw.hourly.soil_moisture_0_to_1cm;
          const lastSoil = Number(smArr[smArr.length - 1]);
          if (!Number.isNaN(lastSoil)) {
            // Open-Meteo soil moisture m³/m³ → mapping kasar ke %
            soilPct = lastSoil * 200;
          }
        }

        if (soilPct === null || Number.isNaN(soilPct)) {
          // fallback heuristik dari curah hujan
          soilPct = 35 + precip * 3;
        }

        soilPct = Math.max(0, Math.min(100, soilPct));

        const timestamp = current.time || new Date().toISOString();

        const data = computeRisk(temp, precip, soilPct, timestamp);
        updateUI(data);

        // History 24 jam untuk grafik
        if (
          raw.hourly &&
          raw.hourly.time &&
          raw.hourly.temperature_2m &&
          raw.hourly.precipitation
        ) {
          const times = raw.hourly.time;
          const temps = raw.hourly.temperature_2m.map(Number);
          const precs = raw.hourly.precipitation.map(Number);

          const len = times.length;
          const take = Math.min(24, len);
          const start = len - take;

          const history = {
            times: times.slice(start),
            temps: temps.slice(start),
            precs: precs.slice(start),
          };
          drawHistoryChart(history);
        }
      } catch (e) {
        console.error("Fetch error", e);
      }
    }

    function computeRisk(temp, precip, soil, timestampIso) {
      let score = 0;

      // Curah hujan
      if (precip > 5) score += 1;
      if (precip > 20) score += 1.5;
      if (precip > 50) score += 2;
      if (precip > 100) score += 3;

      // Kejenuhan tanah
      if (soil > 60) score += 1.5;
      if (soil > 75) score += 2;
      if (soil > 90) score += 2;

      // Kombinasi suhu + hujan
      if (temp > 30 && precip > 20) score += 1;

      // Kondisi kering
      if (precip < 2 && soil < 55) score -= 2;

      let risk_level, label;
      if (score <= 0) {
        risk_level = "AMAN";
        label = "AMAN: kondisi relatif normal";
      } else if (score <= 3) {
        risk_level = "WASPADA";
        label = "WASPADA: banjir lokal / longsor kecil";
      } else if (score <= 6) {
        risk_level = "SIAGA";
        label = "SIAGA: risiko banjir & longsor sedang–tinggi";
      } else {
        risk_level = "DARURAT";
        label = "DARURAT: risiko banjir besar & longsor";
      }

      const ai_confidence = Math.max(
        0.5,
        Math.min(0.99, 0.55 + 0.05 * Math.abs(score))
      );

      return {
        timestamp: timestampIso,
        temperature_c: temp,
        precipitation_mm_per_h: precip,
        soil_saturation_pct: soil,
        risk_level,
        risk_label: label,
        ai_confidence,
      };
    }

    function updateUI(data) {
      if (!data) return;

      if (typeof data.temperature_c === "number") {
        document.getElementById("tempVal").textContent =
          data.temperature_c.toFixed(1);
      }
      if (typeof data.precipitation_mm_per_h === "number") {
        document.getElementById("precipVal").textContent =
          data.precipitation_mm_per_h.toFixed(1);
      }
      if (typeof data.soil_saturation_pct === "number") {
        document.getElementById("soilVal").textContent =
          data.soil_saturation_pct.toFixed(1);
      }

      const t = formatTime(data.timestamp || new Date().toISOString());
      document.getElementById("tempTime").textContent = t;
      document.getElementById("precipTime").textContent = t;
      document.getElementById("soilTime").textContent = t;

      const riskChip = document.getElementById("riskChip");
      const riskLevelLabel = document.getElementById("riskLevelLabel");
      const riskMainText = document.getElementById("riskMainText");
      const confValue = document.getElementById("confValue");
      const confBar = document.getElementById("confBar");

      if (data.risk_level) {
        riskChip.dataset.level = data.risk_level;
        riskLevelLabel.textContent = data.risk_level;
      }
      if (data.risk_label) {
        riskMainText.textContent = data.risk_label.toUpperCase();
      }

      if (typeof data.ai_confidence === "number") {
        const confPercent = Math.round(data.ai_confidence * 100);
        confValue.textContent = confPercent + "%";
        confBar.style.width = confPercent + "%";
      }
    }

    function drawHistoryChart(history) {
      const canvas = document.getElementById("historyChart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0, 0, w, h);

      const n = history.times.length;
      if (!n) return;

      const temps = history.temps;
      const precs = history.precs;

      let minT = Math.min(...temps);
      let maxT = Math.max(...temps);
      if (!isFinite(minT) || !isFinite(maxT)) {
        minT = 0;
        maxT = 1;
      }
      if (maxT === minT) {
        maxT += 1;
        minT -= 1;
      }

      let maxP = Math.max(...precs);
      if (!isFinite(maxP) || maxP <= 0) {
        maxP = 1;
      }

      const paddingLeft = 30;
      const paddingRight = 10;
      const paddingTop = 10;
      const paddingBottom = 18;

      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;

      ctx.fillStyle = "#020617";
      ctx.fillRect(0, 0, w, h);

      // Grid dasar
      ctx.strokeStyle = "#111827";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, paddingTop);
      ctx.lineTo(paddingLeft, paddingTop + chartH);
      ctx.lineTo(paddingLeft + chartW, paddingTop + chartH);
      ctx.stroke();

      // Batang curah hujan (bawah)
      const barWidth = chartW / n;
      ctx.fillStyle = "#1d4ed8"; // biru
      for (let i = 0; i < n; i++) {
        const p = precs[i];
        if (p <= 0) continue;
        const x = paddingLeft + i * barWidth;
        const hP = (p / maxP) * (chartH * 0.5);
        const y = paddingTop + chartH - hP;
        ctx.fillRect(x, y, barWidth * 0.7, hP);
      }

      // Garis suhu (atas)
      ctx.strokeStyle = "#f97316"; // oranye
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      for (let i = 0; i < n; i++) {
        const t = temps[i];
        const norm = (t - minT) / (maxT - minT);
        const x = paddingLeft + (i + 0.5) * barWidth;
        const y = paddingTop + chartH * (1 - norm);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // Label suhu min/max
      ctx.fillStyle = "#6b7280";
      ctx.font = "10px system-ui";
      ctx.textAlign = "right";
      ctx.fillText(maxT.toFixed(0) + "°C", paddingLeft - 4, paddingTop + 8);
      ctx.fillText(minT.toFixed(0) + "°C", paddingLeft - 4, paddingTop + chartH);

      // Label hujan max
      ctx.textAlign = "left";
      ctx.fillText(maxP.toFixed(1) + " mm/h", paddingLeft + chartW + 4, paddingTop + chartH / 2);

      // Label waktu awal & akhir
      const firstTime = new Date(history.times[0]);
      const lastTime = new Date(history.times[n - 1]);
      const fmt = (d) => pad(d.getHours()) + ":" + pad(d.getMinutes());

      ctx.textAlign = "center";
      ctx.fillText(fmt(firstTime), paddingLeft, paddingTop + chartH + 12);
      ctx.fillText(
        fmt(lastTime),
        paddingLeft + chartW,
        paddingTop + chartH + 12
      );
    }

    // initial load & auto-refresh
    fetchStatus();
    setInterval(fetchStatus, 30000);

    const regionSelect = document.getElementById("regionSelect");
    regionSelect.addEventListener("change", () => {
      fetchStatus();
    });
  </script>
</body>
</html>
